<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Note Takers</title>
  <style>
    body { font-family: Arial; max-width: 860px; margin: auto; padding: 18px; font-size: 14px; }
    h2 { margin-bottom: 12px; }
    label.section { font-weight: bold; margin-top: 12px; display: block; }
    input, select, textarea { padding: 6px; margin-top: 4px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; }
    textarea { min-height: 80px; width: 100%; }
    select { max-width: 260px; }
    .contact-row { display: flex; gap: 12px; margin-top: 4px; }
    .contact-row input { flex: 1; }
    .radio-group { display: flex; gap: 16px; margin-top: 6px; }
    .radio-group label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
    .yes { color: green; font-weight: bold; }
    .no { color: red; font-weight: bold; }
    .config-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .config-row input { width: 40%; }
    .config-row select.duration { width: 100px; }
    .config-row select.strategy { width: 140px; }
    .arrow { font-weight: bold; color: #555; margin-left: 5px; margin-right: 5px; }
    .remove-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .remove-btn:hover { background: #e0e0e0; }
    button { margin-top: 12px; padding: 6px 12px; font-size: 13px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #f7f7f7; }
    button:hover { background: #ededed; }
    .actions { display: flex; gap: 10px; margin-top: 14px; }
    .disabled { background: #f0f0f0; pointer-events: none; }
  </style>
</head>
<body>

<h2>Note Takers</h2>

<label class="section">Integration Type</label>
<select id="integrationType">
  <option>OCS Integration</option>
  <option>OpenDental API Integration</option>
  <option>Denticon Integration</option>
  <option>NexHealth Integration</option>
  <option>Sikka Integration</option>
</select>

<label class="section">Contact Info</label>
<div class="contact-row">
  <input id="contactName" placeholder="Contact Name">
  <input id="phoneNumber" placeholder="Phone Number">
</div>

<label class="section">Integration Status</label>
<select id="integrationStatus">
  <option value="" selected disabled>Select status</option>
  <option>Pending</option>
  <option>Active</option>
  <option>Stalled</option>
</select>

<label class="section">Server Access</label>
<div class="radio-group">
  <label><input type="radio" name="serverAccess" value="Yes"><span class="yes">✔</span>Yes</label>
  <label><input type="radio" name="serverAccess" value="No"><span class="no">✖</span>No</label>
</div>

<label class="section">Calendar Sync Configured</label>
<div class="radio-group">
  <label><input type="radio" name="calendarSync" value="Yes"> <span class="yes">✔</span>Yes</label>
  <label><input type="radio" name="calendarSync" value="No"> <span class="no">✖</span>No</label>
</div>

<label class="section">Configs / Operatory Setup</label>
<div id="configsContainer"></div>
<button id="addOperatoryBtn" onclick="addConfig()">+ Add Operatory</button>

<label class="section">Blocker</label>
<textarea id="blocker" placeholder="- "></textarea>

<label class="section">Setup Summary</label>
<textarea id="setupSummary" placeholder="- Calendar sync completed"></textarea>

<div class="actions">
  <button id="gptFixBtn">Fix Grammar</button>
  <button id="copyBtn">Copy to Clipboard</button>
  <button onclick="clearAll()">Clear All</button>
</div>

<script>
const BACKEND_URL = "https://notes-backend-yheh.onrender.com";
const configsContainer = document.getElementById("configsContainer");
const addBtn = document.getElementById("addOperatoryBtn");

/* Duration dropdown */
function durationDropdown(){
  let html = `<select class="duration"><option value="">Duration</option>`;
  for(let i=5;i<=120;i+=5) html += `<option>${i} mins</option>`;
  return html + `</select>`;
}

/* Strategy dropdown */
function strategyDropdown(){
  return `<select class="strategy">
    <option value="Any Room">Any Room</option>
    <option value="All Rooms">All Rooms</option>
    <option value="Sequential">Sequential</option>
  </select>`;
}

/* Add config row */
function addConfig(isSequentialSecond=false){
  const row = document.createElement("div");
  row.className = "config-row";

  const strategyHtml = isSequentialSecond ? "" : strategyDropdown();
  const arrowHtml = isSequentialSecond ? '<span class="arrow">→</span>' : '<span class="arrow" style="display:none;">→</span>';

  row.innerHTML = `
    <input placeholder="Column / Operatory">
    ${durationDropdown()}
    ${strategyHtml}
    ${arrowHtml}
    <button class="remove-btn">✕</button>
  `;

  const strategySelect = row.querySelector(".strategy");
  const arrowSpan = row.querySelector(".arrow");

  row.querySelector(".remove-btn").onclick = () => {
    const rows = [...document.querySelectorAll(".config-row")];
    const index = rows.indexOf(row);
    if(strategySelect && strategySelect.value==="Sequential" && rows[index+1]) rows[index+1].remove();
    row.remove();
  };

  if(strategySelect){
    strategySelect.addEventListener("change",()=>{
      const rows=[...document.querySelectorAll(".config-row")];
      const index=rows.indexOf(row);
      if(strategySelect.value==="Sequential"){
        arrowSpan.style.display="inline";
        if(!rows[index+1]) addConfig(true);
      } else {
        arrowSpan.style.display="none";
        if(rows[index+1] && !rows[index+1].querySelector(".strategy")) rows[index+1].remove();
      }
    });
  }

  configsContainer.appendChild(row);
}

/* Clear all */
function clearAll(){
  document.querySelectorAll("input").forEach(i=>{
    if(i.type==="radio") i.checked=false; else i.value="";
  });
  document.querySelectorAll("textarea").forEach(t=>t.value="");
  document.querySelectorAll("select").forEach(s=>s.selectedIndex=0);
  configsContainer.innerHTML="";
  addConfig();
  enableConfigs(true);
}

/* Auto bullets for summary */
setupSummary.addEventListener("keydown", e=>{
  if(e.key==="Enter"){ e.preventDefault(); setupSummary.value += "\n- "; }
});
setupSummary.addEventListener("blur", ()=>{
  setupSummary.value = setupSummary.value
    .split("\n").map(l=>l.trim()).filter(Boolean)
    .map(l=>l.startsWith("-")?l:`- ${l}`).join("\n");
});

/* Auto bullets for blocker */
blocker.addEventListener("keydown", e=>{
  if(e.key==="Enter"){ e.preventDefault(); blocker.value += "\n- "; }
});
blocker.addEventListener("blur", ()=>{
  blocker.value = blocker.value
    .split("\n").map(l=>l.trim()).filter(Boolean)
    .map(l=>l.startsWith("-")?l:`- ${l}`).join("\n");
});

/* Enable/Disable configs */
function enableConfigs(enable){
  document.querySelectorAll(".config-row input, .config-row select").forEach(el=>{
    if(el.tagName==="SELECT" || el.tagName==="INPUT") el.disabled = !enable;
    if(!enable) el.classList.add("disabled"); else el.classList.remove("disabled");
  });
  addBtn.disabled = !enable;
}

/* Calendar sync behavior */
document.querySelectorAll('input[name="calendarSync"]').forEach(r=>{
  r.addEventListener("change", ()=>{
    if(r.value==="No"){
      configsContainer.innerHTML = '<div>- N/A</div>';
      enableConfigs(false);
    } else {
      configsContainer.innerHTML="";
      addConfig();
      enableConfigs(true);
    }
  });
});

/* GPT Fix */
gptFixBtn.onclick=async()=>{
  if(!setupSummary.value) return;
  const res=await fetch(`${BACKEND_URL}/summary`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text:setupSummary.value})
  });
  const data=await res.json();
  setupSummary.value=data.cleaned;
};

/* Copy note */
copyBtn.onclick=async()=>{
  const serverAccess=document.querySelector('input[name="serverAccess"]:checked')?.value||"Not set";
  const calendarSync=document.querySelector('input[name="calendarSync"]:checked')?.value||"Not set";

  const rows=[...document.querySelectorAll(".config-row")];
  const configs=rows.map((r,i)=>{
    const op=r.querySelector("input")?.value || "";
    const dur=r.querySelector(".duration")?.value || "";
    const strat=r.querySelector(".strategy");
    const isSequentialSecond = !strat;

    if(rows.length===1 && r.innerText.trim()==="- N/A") return "- N/A";

    if(isSequentialSecond){
      const prev=rows[i-1];
      const prevOp=prev.querySelector("input").value;
      const prevDur=prev.querySelector(".duration").value;
      return `- ${prevOp} | ${prevDur} → ${op} | ${dur} Sequential`;
    }

    if(strat && strat.value==="Sequential" && rows[i+1]) return "";
    return `- ${op} | ${dur} | ${strat?strat.value:""}`;
  }).filter(Boolean).join("\n");

  const note=`
${integrationType.value}

Contact Name: ${contactName.value}
Phone Number: ${phoneNumber.value}
Integration Status: ${integrationStatus.value||"Not set"}

Server Access: ${serverAccess}
Calendar Sync Configured: ${calendarSync}

Configs / Operatory Setup:
${configs}

Blocker:
${blocker.value}

Setup Summary:
${setupSummary.value}
`.trim();

  await navigator.clipboard.writeText(note);
  alert("Copied to clipboard");
};
</script>
</body>
</html>
