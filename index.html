<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EZ Note Generator</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 18px;
  font-size: 14px;
}

label.section {
  font-weight: bold;
  margin-top: 12px;
  display: block;
}

input, select, textarea {
  padding: 6px;
  margin-top: 4px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

textarea {
  width: 100%;
  min-height: 80px;
}

.contact-row {
  display: flex;
  gap: 12px;
}

.radio-group {
  display: flex;
  gap: 16px;
  margin-top: 6px;
}

.provider-group {
  border: 1px solid #ddd;
  padding: 8px;
  margin-top: 10px;
  border-radius: 6px;
}

.provider-header {
  display: flex;
  gap: 6px;
  align-items: center;
}

.provider-header input {
  flex: 1;
}

.config-group {
  margin-left: 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.config-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.duration { width: 120px; }
.strategy { width: 140px; }

.arrow { font-weight: bold; }

button {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #f5f5f5;
  cursor: pointer;
}

button:disabled {
  background: #eee;
  cursor: not-allowed;
}

.remove-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
}

.add-btn {
  margin-top: 6px;
}

.actions {
  display: flex;
  gap: 10px;
  margin-top: 14px;
}

#configsSection {
  display: none;
}
</style>
</head>

<body>

<label class="section">Integration Type</label>
<select id="integrationType">
  <option value="" selected disabled>Select</option>
  <option>Opencare Sync</option>
  <option>NexHealth API</option>
</select>

<label class="section">Contact Info</label>
<div class="contact-row">
  <input id="contactName" placeholder="Contact Name">
  <input id="phoneNumber" placeholder="Phone Number">
</div>

<label class="section">Integration Status</label>
<select id="integrationStatus">
  <option value="" selected disabled>Select</option>
  <option>Pending</option>
  <option>Active</option>
</select>

<label class="section">Server Access</label>
<div class="radio-group">
  <label><input type="radio" name="serverAccess" value="Yes"> Yes</label>
  <label><input type="radio" name="serverAccess" value="No"> No</label>
</div>

<label class="section">Calendar Sync Configured</label>
<div class="radio-group">
  <label><input type="radio" name="calendarSync" value="Yes"> Yes</label>
  <label><input type="radio" name="calendarSync" value="No"> No</label>
</div>

<div id="configsSection">
  <button class="add-btn" onclick="addProvider()">‚ûï Add Provider</button>
  <div id="providersContainer"></div>
</div>

<label class="section">Blocker</label>
<textarea id="blocker"></textarea>

<label class="section">Setup Summary</label>
<textarea id="setupSummary"></textarea>

<div class="actions">
  <button id="copyBtn" disabled>üìã Copy to Clipboard</button>
  <button id="gptFixBtn">‚úèÔ∏è Fix Grammar</button>
  <button id="saveFileBtn" disabled>üíæ Save</button>
</div>

<button onclick="clearAll()">üßπ Clear All</button>

<script>
const BACKEND_URL = "https://notes-backend-yheh.onrender.com";
const providersContainer = document.getElementById("providersContainer");
const configsSection = document.getElementById("configsSection");
const integrationType = document.getElementById("integrationType");
const integrationStatus = document.getElementById("integrationStatus");
const contactName = document.getElementById("contactName");
const phoneNumber = document.getElementById("phoneNumber");
const blocker = document.getElementById("blocker");
const setupSummary = document.getElementById("setupSummary");
const copyBtn = document.getElementById("copyBtn");
const saveFileBtn = document.getElementById("saveFileBtn");

function durationDropdown() {
  let html = `<select class="duration"><option value="">Duration</option>`;
  for (let i = 5; i <= 120; i += 5) html += `<option>${i} minutes</option>`;
  return html + `</select>`;
}

function strategyDropdown() {
  return `<select class="strategy">
    <option value="Any Rooms">Any Rooms</option>
    <option value="All Rooms">All Rooms</option>
    <option value="Sequential">Sequential</option>
  </select>`;
}

function addOperatoryRow(container, isSequential = false) {
  const row = document.createElement("div");
  row.className = "config-row";
  row.innerHTML = `
    <input placeholder="Column / Operatory">
    ${durationDropdown()}
    ${isSequential ? "" : strategyDropdown()}
    <span class="arrow" style="display:${isSequential ? "inline" : "none"}">‚Üí</span>
    <button class="remove-btn">‚úï</button>
  `;
  row.querySelector(".remove-btn").onclick = () => {
    row.remove();
    validateFields();
  };

  const strategy = row.querySelector(".strategy");
  if (strategy) {
    strategy.onchange = () => {
      if (strategy.value === "Sequential") {
        row.querySelector(".arrow").style.display = "inline";
        addOperatoryRow(container, true);
      }
      validateFields();
    };
  }

  row.querySelectorAll("input, select").forEach(e => e.oninput = validateFields);
  container.appendChild(row);
}

function addProvider() {
  const group = document.createElement("div");
  group.className = "provider-group";
  group.innerHTML = `
    <div class="provider-header">
      <input class="provider-name" placeholder="Provider Name">
      <button class="remove-btn">‚úï</button>
    </div>
    <div class="config-group"></div>
    <button class="add-btn">‚ûï Add Operatory</button>
  `;
  const configGroup = group.querySelector(".config-group");
  group.querySelector(".add-btn").onclick = () => addOperatoryRow(configGroup);
  group.querySelector(".remove-btn").onclick = () => {
    group.remove();
    validateFields();
  };
  group.querySelector(".provider-name").oninput = validateFields;

  providersContainer.appendChild(group);
  addOperatoryRow(configGroup);
}

document.querySelectorAll('input[name="calendarSync"]').forEach(r => {
  r.onchange = () => {
    configsSection.style.display = r.value === "Yes" ? "block" : "none";
    providersContainer.innerHTML = "";
    if (r.value === "Yes") addProvider();
    validateFields();
  };
});

function validateFields() {
  const required =
    integrationType.value &&
    integrationStatus.value &&
    document.querySelector('input[name="serverAccess"]:checked') &&
    document.querySelector('input[name="calendarSync"]:checked');

  copyBtn.disabled = !required;
  saveFileBtn.disabled = !required;
}

function generateCurrentNote() {
  const serverAccess = document.querySelector('input[name="serverAccess"]:checked')?.value;
  const calendarSync = document.querySelector('input[name="calendarSync"]:checked')?.value;

  let text = `Integration Type: ${integrationType.value}

Contact Name: ${contactName.value}
Phone Number: ${phoneNumber.value}
Integration Status: ${integrationStatus.value}

Server Access: ${serverAccess}
Calendar Sync Configured: ${calendarSync}
`;

  if (calendarSync === "Yes") {
    text += `\nConfigs / Operatory Setup:\n`;
    document.querySelectorAll(".provider-group").forEach(group => {
      text += `${group.querySelector(".provider-name").value}:\n`;
      const rows = [...group.querySelectorAll(".config-row")];
      let i = 0;
      while (i < rows.length) {
        const r = rows[i];
        const op = r.querySelector("input").value;
        const dur = r.querySelector(".duration").value;
        const strat = r.querySelector(".strategy")?.value;
        if (strat === "Sequential" && rows[i + 1]) {
          const r2 = rows[i + 1];
          text += `    ${op} ${dur} to ${r2.querySelector("input").value} ${r2.querySelector(".duration").value} | Sequential\n`;
          i += 2;
        } else {
          text += `    ${op} ${dur} | ${strat}\n`;
          i++;
        }
      }
    });
  }

  text += `\nBlocker:\n${blocker.value}\n\nSetup Summary:\n${setupSummary.value}`;
  return text.trim();
}

copyBtn.onclick = async () => {
  await navigator.clipboard.writeText(generateCurrentNote());
  alert("Copied");
};

saveFileBtn.onclick = () => {
  const blob = new Blob([generateCurrentNote()], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "EZ_Note.txt";
  a.click();
};

document.getElementById("gptFixBtn").onclick = async () => {
  const res = await fetch(`${BACKEND_URL}/summary`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: setupSummary.value })
  });
  setupSummary.value = (await res.json()).cleaned;
};

function clearAll() {
  document.querySelectorAll("input").forEach(i => i.type === "radio" ? i.checked = false : i.value = "");
  document.querySelectorAll("textarea").forEach(t => t.value = "");
  document.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
  providersContainer.innerHTML = "";
  configsSection.style.display = "none";
}
</script>
</body>
</html>
