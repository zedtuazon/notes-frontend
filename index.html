<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>EZ Note Generator</title>
<style>
body { font-family: Arial; max-width: 900px; margin: auto; padding: 18px; font-size: 14px; background:#fdfdfd; }
label.section { font-weight: bold; margin-top: 12px; display: block; }
input, select, textarea { padding: 6px; margin-top: 4px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
textarea { min-height: 80px; width: 100%; resize: vertical; }
select { max-width: 260px; }
.contact-row { display: flex; gap: 12px; margin-top: 4px; }
.contact-row input { flex: 1; }
.radio-group { display: flex; gap: 16px; margin-top: 6px; }
.radio-group label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
.yes { color: green; font-weight: bold; }
.no { color: red; font-weight: bold; }

/* Provider group */
.provider-group { margin-top: 12px; padding: 8px; border-radius: 6px; background: #fafafa; border: 1px solid #ddd; display: flex; flex-direction: column; gap: 6px; }
.provider-header { display:flex; align-items:center; gap:6px; justify-content: space-between; }
.provider-header input { flex: 1; }

/* Indented operatory rows */
.config-group { display: flex; flex-direction: column; gap: 6px; margin-left: 16px; }

.config-row { display: flex; gap: 8px; align-items: center; }
.config-row input { width: 40%; }
.config-row select.duration { width: 100px; }
.config-row select.strategy { width: 140px; }
.arrow { font-weight: bold; color: #555; margin: 0 5px; }
.remove-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
.remove-btn:hover { background: #e0e0e0; }

.add-btn { padding: 4px 10px; border-radius: 6px; border: 1px solid #ccc; background:#f7f7f7; cursor:pointer; font-size:14px; margin-top:6px; transition: all 0.2s; align-self:flex-start; }
.add-btn:hover { background:#e0f0ff; border-color:#4a90e2; }

button { margin-top: 12px; padding: 6px 12px; font-size: 13px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #f7f7f7; display:flex; align-items:center; gap:6px; }
button:disabled { background:#f0f0f0; cursor:not-allowed; }
.actions { display: flex; gap: 10px; margin-top: 14px; }

.header { display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 28px; font-weight: bold; margin-bottom: 16px; }
#practiceName { width: 100%; height: 34px; box-sizing: border-box; }
#configsSection { display: none; margin-top: 8px; }
</style>
</head>
<body>

<div class="header">üìù EZ Note Generator</div>

<label class="section">Practice Name</label>
<input id="practiceName" placeholder="Enter Practice Name (for file name only)">

<label class="section">Integration Type</label>
<select id="integrationType">
  <option value="" selected disabled>Select Integration Type</option>
  <option>Opencare Sync</option>
  <option>NexHealth API</option>
  <option>Sikka API</option>
  <option>Carestack API</option>
  <option>Denticon API</option>
  <option>Opendental API</option>
</select>

<label class="section">Contact Info</label>
<div class="contact-row">
  <input id="contactName" placeholder="Contact Name">
  <input id="phoneNumber" placeholder="Phone Number">
</div>

<label class="section">Integration Status</label>
<select id="integrationStatus">
  <option value="" selected disabled>Select status</option>
  <option>Pending</option>
  <option>Active</option>
  <option>Stalled</option>
</select>

<label class="section">Server Access</label>
<div class="radio-group">
  <label><input type="radio" name="serverAccess" value="Yes"> <span class="yes">‚úî</span>Yes</label>
  <label><input type="radio" name="serverAccess" value="No"> <span class="no">‚úñ</span>No</label>
</div>

<label class="section">Calendar Sync Configured</label>
<div class="radio-group">
  <label><input type="radio" name="calendarSync" value="Yes"> <span class="yes">‚úî</span>Yes</label>
  <label><input type="radio" name="calendarSync" value="No"> <span class="no">‚úñ</span>No</label>
</div>

<!-- Provider Section -->
<div id="configsSection">
  <button class="add-btn" id="addProviderBtn" onclick="addProvider()">‚ûï Add Provider</button>
  <div id="providersContainer"></div>
</div>

<label class="section">Blocker</label>
<textarea id="blocker" placeholder=""></textarea>

<label class="section">Setup Summary</label>
<textarea id="setupSummary" placeholder=""></textarea>

<div class="actions">
  <button id="copyBtn" disabled>üìã Copy to Clipboard</button>
  <button id="gptFixBtn">‚úèÔ∏è Fix Grammar</button>
  <button id="saveFileBtn" disabled>üíæ Save</button>
</div>

<button onclick="clearAll()">üßπ Clear All</button>

<script>
// Constants
const BACKEND_URL = "https://notes-backend-yheh.onrender.com";
const providersContainer = document.getElementById("providersContainer");
const configsSection = document.getElementById("configsSection");
const integrationType = document.getElementById("integrationType");
const integrationStatus = document.getElementById("integrationStatus");
const contactName = document.getElementById("contactName");
const phoneNumber = document.getElementById("phoneNumber");
const blocker = document.getElementById("blocker");
const setupSummary = document.getElementById("setupSummary");
const copyBtn = document.getElementById("copyBtn");
const saveFileBtn = document.getElementById("saveFileBtn");

// Duration & Strategy
function durationDropdown(){ let html = `<select class="duration"><option value="">Duration</option>`; for(let i=5;i<=120;i+=5) html+=`<option>${i} minutes</option>`; return html+`</select>`; }
function strategyDropdown(){ return `<select class="strategy"><option value="Any Room">Any Rooms</option><option value="All Rooms">All Rooms</option><option value="Sequential">Sequential</option></select>`; }

// Add Operatory Row
function addOperatoryRow(container,isSequential=false){
  const row=document.createElement("div"); row.className="config-row";
  row.innerHTML=`<input placeholder="Column / Operatory">${durationDropdown()}${isSequential?"":strategyDropdown()}<span class="arrow" style="display:${isSequential?'inline':'none'}">‚Üí</span><button class="remove-btn">‚úï</button>`;
  const strategy=row.querySelector(".strategy"), arrow=row.querySelector(".arrow");
  row.querySelector(".remove-btn").onclick=()=>{row.remove();validateFields();};
  row.querySelector("input").addEventListener("input",validateFields);
  row.querySelector(".duration").addEventListener("change",validateFields);
  if(strategy) strategy.addEventListener("change",()=>{
    if(strategy.value==="Sequential"){ arrow.style.display="inline"; addOperatoryRow(container,true); } else{ arrow.style.display="none"; }
    validateFields();
  });
  container.appendChild(row);
  validateFields();
}

// Add Provider
function addProvider(){
  const providerGroup=document.createElement("div"); providerGroup.className="provider-group";
  providerGroup.innerHTML=`
    <div class="provider-header">
      <input class="provider-name" placeholder="Provider Name">
      <button class="remove-btn">‚úï</button>
    </div>
    <div class="config-group"></div>
    <button class="add-btn">‚ûï Add Operatory</button>
  `;
  const configGroup=providerGroup.querySelector(".config-group");
  const addBtn=providerGroup.querySelector(".add-btn");
  const removeBtn=providerGroup.querySelector(".provider-header .remove-btn");
  addBtn.onclick=()=>addOperatoryRow(configGroup,false);
  removeBtn.onclick=()=>{providerGroup.remove(); validateFields();};
  providerGroup.querySelector(".provider-name").addEventListener("input",validateFields);
  providersContainer.appendChild(providerGroup);
  addOperatoryRow(configGroup,false);
  validateFields();
}

// Calendar Sync toggle
document.querySelectorAll('input[name="calendarSync"]').forEach(r=>{
  r.onchange = () => {
    if(r.value === "Yes"){
      configsSection.style.display = "block";
      if(providersContainer.children.length === 0) addProvider();
    } else {
      configsSection.style.display = "none";
      providersContainer.innerHTML = "";
    }
    validateFields();
  };
});

// Validation
function validateFields(){
  const integrationTypeVal = integrationType.value;
  const integrationStatusVal = integrationStatus.value;
  const serverAccessVal = document.querySelector('input[name="serverAccess"]:checked')?.value;
  const calendarSyncVal = document.querySelector('input[name="calendarSync"]:checked')?.value;

  let providersFilled = true;
  if(calendarSyncVal === "Yes"){
    const groups = [...document.querySelectorAll(".provider-group")];
    if(groups.length === 0) providersFilled = false;
    groups.forEach(g => {
      const pname = g.querySelector(".provider-name")?.value;
      if(!pname) providersFilled = false;
      const rows = [...g.querySelectorAll(".config-row")];
      if(rows.length === 0) providersFilled = false;
      let i=0;
      while(i<rows.length){
        const row=rows[i];
        const col=row.querySelector("input")?.value;
        const dur=row.querySelector(".duration")?.value;
        const strat=row.querySelector(".strategy")?.value;
        if(!col||!dur) providersFilled=false;
        if(strat==="Sequential" && rows[i+1]){
          const nextRow=rows[i+1]; const nextCol=nextRow.querySelector("input")?.value; const nextDur=nextRow.querySelector(".duration")?.value;
          if(!nextCol||!nextDur) providersFilled=false;
          i+=2; continue;
        }
        i++;
      }
    });
  }

  const allFilled = integrationTypeVal && integrationStatusVal && serverAccessVal && calendarSyncVal && providersFilled;
  copyBtn.disabled = !allFilled;
  saveFileBtn.disabled = !allFilled;
}

// Generate Note
function generateCurrentNote(){
  const serverAccess=document.querySelector('input[name="serverAccess"]:checked')?.value || "Not set";
  const calendarSync=document.querySelector('input[name="calendarSync"]:checked')?.value || "Not set";
  let configsText = "";
  if(calendarSync==="Yes"){
    const providerGroups=[...document.querySelectorAll(".provider-group")];
    if(providerGroups.length === 0){ configsText = "N/A"; }
    else{
      providerGroups.forEach(group=>{
        const providerName = group.querySelector(".provider-name")?.value || "";
        if(!providerName) return;
        configsText += providerName + ":\n";
        const rows = [...group.querySelectorAll(".config-row")];
        let i = 0;
        while(i < rows.length){
          const row = rows[i];
          const operatory = row.querySelector("input")?.value || "";
          const dur = row.querySelector(".duration")?.value || "";
          const strat = row.querySelector(".strategy")?.value || "";

          if(strat === "Sequential" && rows[i+1]){
            const nextRow = rows[i+1];
            const nextOperatory = nextRow.querySelector("input")?.value || "";
            const nextDur = nextRow.querySelector(".duration")?.value || "";
            configsText += `    ${operatory} ${dur} to ${nextOperatory} ${nextDur} | Sequential\n`;
            i += 2; continue;
          }

          let stratText = "";
          if(strat){
            if(strat==="Sequential") stratText="Sequential";
            else if(strat==="All Rooms") stratText="All Rooms";
            else if(strat==="Any Room") stratText="Any Rooms";
          }

          configsText += `    ${operatory} ${dur}` + (stratText?` | ${stratText}`:"") + "\n";
          i++;
        }
      });
    }
  }

  return `
Integration Type: ${integrationType.value || "Not selected"}

Contact Name: ${contactName.value}
Phone Number: ${phoneNumber.value}
Integration Status: ${integrationStatus.value || "Not set"}

Server Access: ${serverAccess}
Calendar Sync Configured: ${calendarSync}

${calendarSync==="Yes"?"Configs / Operatory Setup:\n"+configsText:""}

Blocker:
${blocker.value}

Setup Summary:
${setupSummary.value}
  `.trim();
}

// Clear All
function clearAll(){ 
  document.querySelectorAll("input").forEach(i=>i.type==="radio"?i.checked=false:i.value=""); 
  document.querySelectorAll("textarea").forEach(t=>t.value=""); 
  document.querySelectorAll("select").forEach(s=>s.selectedIndex=0); 
  providersContainer.innerHTML=""; configsSection.style.display="none"; validateFields(); 
}

// Copy to Clipboard
copyBtn.onclick=async()=>{ const note=generateCurrentNote(); await navigator.clipboard.writeText(note); alert("Copied to clipboard"); };

// Save
saveFileBtn.onclick=()=>{ 
  const note=generateCurrentNote(); 
  const fileName=(document.getElementById("practiceName").value||"EZ_Note").replace(/[^a-z0-9]/gi,"_")+".txt"; 
  const blob=new Blob([note],{type:"text/plain"}); 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement("a"); 
  a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url); 
};

// GPT Fix
document.getElementById("gptFixBtn").onclick=async()=>{
  if(!setupSummary.value)return; 
  const res=await fetch(`${BACKEND_URL}/summary`,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text:setupSummary.value}) }); 
  setupSummary.value=(await res.json()).cleaned; 
};
</script>
</body>
</html>
