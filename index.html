<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EZ Note Generator</title>

  <style>
    body { font-family: Arial; max-width: 860px; margin: auto; padding: 18px; font-size: 14px; background:#fdfdfd; }
    label.section { font-weight: bold; margin-top: 12px; display: block; }
    input, select, textarea { padding: 6px; margin-top: 4px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    textarea { min-height: 80px; width: 100%; resize: vertical; }
    select { max-width: 260px; }
    .contact-row { display: flex; gap: 12px; margin-top: 4px; }
    .contact-row input { flex: 1; }
    .radio-group { display: flex; gap: 16px; margin-top: 6px; }
    .radio-group label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
    .yes { color: green; font-weight: bold; }
    .no { color: red; font-weight: bold; }

    .config-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .config-row input { width: 40%; }
    .config-row select.duration { width: 100px; }
    .config-row select.strategy { width: 140px; }

    .arrow { font-weight: bold; color: #555; margin: 0 5px; }

    .remove-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button {
      margin-top: 12px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    button:disabled { background:#f0f0f0; cursor:not-allowed; }

    .actions { display: flex; gap: 10px; margin-top: 14px; }

    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 16px;
    }

    #practiceName {
      width: 100%;
      height: 34px;
      box-sizing: border-box;
    }

    #configsSection {
      display: none;
      margin-top: 4px;
    }
  </style>
</head>

<body>

<div class="header">üìù EZ Note Generator</div>

<label class="section">Practice Name</label>
<input id="practiceName" placeholder="Enter Practice Name (for file name only)">

<label class="section">Integration Type</label>
<select id="integrationType">
  <option value="" selected disabled>Select Integration Type</option>
  <option>Opencare Sync</option>
  <option>NexHealth API</option>
  <option>Sikka API</option>
  <option>Carestack API</option>
  <option>Denticon API</option>
  <option>Opendental API</option>
</select>

<label class="section">Contact Info</label>
<div class="contact-row">
  <input id="contactName" placeholder="Contact Name">
  <input id="phoneNumber" placeholder="Phone Number">
</div>

<label class="section">Integration Status</label>
<select id="integrationStatus">
  <option value="" selected disabled>Select status</option>
  <option>Pending</option>
  <option>Active</option>
  <option>Stalled</option>
</select>

<label class="section">Server Access</label>
<div class="radio-group">
  <label><input type="radio" name="serverAccess" value="Yes"> <span class="yes">‚úî</span>Yes</label>
  <label><input type="radio" name="serverAccess" value="No"> <span class="no">‚úñ</span>No</label>
</div>

<label class="section">Calendar Sync Configured</label>
<div class="radio-group">
  <label><input type="radio" name="calendarSync" value="Yes"> <span class="yes">‚úî</span>Yes</label>
  <label><input type="radio" name="calendarSync" value="No"> <span class="no">‚úñ</span>No</label>
</div>

<!-- CONFIGS SECTION (CONDITIONAL) -->
<div id="configsSection">
  <label class="section">Configs / Operatory Setup</label>
  <div id="configsContainer"></div>
  <button onclick="addConfig()">‚ûï Add Operatory</button>
</div>

<label class="section">Blocker</label>
<textarea id="blocker" placeholder="- "></textarea>

<label class="section">Setup Summary</label>
<textarea id="setupSummary" placeholder="- Calendar sync completed"></textarea>

<div class="actions">
  <button id="copyBtn" disabled>üìã Copy to Clipboard</button>
  <button id="gptFixBtn">‚úèÔ∏è Fix Grammar</button>
  <button id="saveFileBtn" disabled>üíæ Save</button>
</div>

<button onclick="clearAll()">üßπ Clear All</button>

<script>
const BACKEND_URL = "https://notes-backend-yheh.onrender.com";
const configsContainer = document.getElementById("configsContainer");
const configsSection = document.getElementById("configsSection");

const integrationType = document.getElementById("integrationType");
const integrationStatus = document.getElementById("integrationStatus");
const contactName = document.getElementById("contactName");
const phoneNumber = document.getElementById("phoneNumber");
const blocker = document.getElementById("blocker");
const setupSummary = document.getElementById("setupSummary");
const copyBtn = document.getElementById("copyBtn");
const saveFileBtn = document.getElementById("saveFileBtn");
const gptFixBtn = document.getElementById("gptFixBtn");

/* Dropdown builders */
function durationDropdown(){
  let html = `<select class="duration"><option value="">Duration</option>`;
  for(let i=5;i<=120;i+=5) html += `<option>${i} mins</option>`;
  return html + `</select>`;
}

function strategyDropdown(){
  return `<select class="strategy">
    <option value="Any Room">Any Room</option>
    <option value="All Rooms">All Rooms</option>
    <option value="Sequential">Sequential</option>
  </select>`;
}

/* Add config row */
function addConfig(isSequentialSecond=false){
  const row = document.createElement("div");
  row.className = "config-row";

  row.innerHTML = `
    <input placeholder="Column / Operatory">
    ${durationDropdown()}
    ${isSequentialSecond ? "" : strategyDropdown()}
    <span class="arrow" style="display:${isSequentialSecond?'inline':'none'}">‚Üí</span>
    <button class="remove-btn">‚úï</button>
  `;

  const strategy = row.querySelector(".strategy");
  const arrow = row.querySelector(".arrow");

  row.querySelector(".remove-btn").onclick = () => row.remove();

  if(strategy){
    strategy.onchange = () => {
      if(strategy.value === "Sequential"){
        arrow.style.display = "inline";
        addConfig(true);
      } else {
        arrow.style.display = "none";
      }
    };
  }

  configsContainer.appendChild(row);
  validateFields();
}

/* Calendar Sync toggle */
document.querySelectorAll('input[name="calendarSync"]').forEach(r=>{
  r.onchange = () => {
    if(r.value === "Yes"){
      configsSection.style.display = "block";
      configsContainer.innerHTML = "";
      addConfig();
    } else {
      configsSection.style.display = "none";
      configsContainer.innerHTML = "";
    }
    validateFields();
  };
});

/* Generate full note with combined sequential rows */
function generateCurrentNote(){
  const serverAccess = document.querySelector('input[name="serverAccess"]:checked')?.value || "Not set";
  const calendarSync = document.querySelector('input[name="calendarSync"]:checked')?.value || "Not set";

  let configsText = "- N/A";
  if(calendarSync === "Yes"){
    const rows = [...document.querySelectorAll(".config-row")];
    let result = [];
    let i = 0;

    while(i < rows.length){
      const row = rows[i];
      const op = row.querySelector("input")?.value || "";
      const dur = row.querySelector(".duration")?.value.replace("mins","minutes") || "";
      const strat = row.querySelector(".strategy")?.value || "";

      // Sequential logic
      if(strat === "Sequential"){
        const nextRow = rows[i+1];
        if(nextRow){
          const nextOp = nextRow.querySelector("input")?.value || "";
          const nextDur = nextRow.querySelector(".duration")?.value.replace("mins","minutes") || "";
          result.push(`${op} ${dur} to ${nextOp} ${nextDur} | Sequential Room`);
          i += 2; // skip next row
          continue;
        } else {
          result.push(`${op} ${dur} | Sequential Room`);
        }
      } else if(strat){
        result.push(`${op} ${dur} | ${strat.replace("s","")} Room`);
      } else {
        result.push(`${op} ${dur}`);
      }
      i++;
    }

    configsText = result.join("\n");
  }

  return `
Integration Type: ${integrationType.value || "Not selected"}

Contact Name: ${contactName.value}
Phone Number: ${phoneNumber.value}
Integration Status: ${integrationStatus.value || "Not set"}

Server Access: ${serverAccess}
Calendar Sync Configured: ${calendarSync}

Configs / Operatory Setup:
${configsText}

Blocker:
${blocker.value}

Setup Summary:
${setupSummary.value}
  `.trim();
}

/* Clear all */
function clearAll(){
  document.querySelectorAll("input").forEach(i=>i.type==="radio"?i.checked=false:i.value="");
  document.querySelectorAll("textarea").forEach(t=>t.value="");
  document.querySelectorAll("select").forEach(s=>s.selectedIndex=0);
  configsContainer.innerHTML="";
  configsSection.style.display="none";
  validateFields();
}

/* Validate fields */
function validateFields(){
  const required =
    integrationType.value &&
    integrationStatus.value &&
    document.querySelector('input[name="serverAccess"]:checked') &&
    document.querySelector('input[name="calendarSync"]:checked');

  copyBtn.disabled = !required;
  saveFileBtn.disabled = !required;
}

/* Copy to Clipboard */
copyBtn.onclick = async () => {
  const note = generateCurrentNote();
  await navigator.clipboard.writeText(note);
  alert("Copied to clipboard");
};

/* Save to file */
saveFileBtn.onclick = () => {
  const note = generateCurrentNote();
  const practiceNameVal = document.getElementById("practiceName").value || "EZ_Note";
  const blob = new Blob([note], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = practiceNameVal.replace(/[^a-z0-9]/gi, "_") + ".txt";
  a.click();
  URL.revokeObjectURL(url);
};

/* GPT Fix */
gptFixBtn.onclick = async()=>{
  if(!setupSummary.value) return;
  const res = await fetch(`${BACKEND_URL}/summary`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text:setupSummary.value})
  });
  setupSummary.value = (await res.json()).cleaned;
};

/* Auto-validate */
[integrationType, integrationStatus, contactName, phoneNumber, blocker, setupSummary].forEach(el=>{
  el.addEventListener("input", validateFields);
});
document.querySelectorAll('input[name="serverAccess"], input[name="calendarSync"]').forEach(r=>{
  r.addEventListener("change", validateFields);
});

</script>
</body>
</html>
