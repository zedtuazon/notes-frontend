<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EZ Note Generator</title>
  <style>
    body { font-family: Arial; max-width: 860px; margin: auto; padding: 18px; font-size: 14px; background:#fdfdfd; }
    label.section { font-weight: bold; margin-top: 12px; display: block; }
    input, select, textarea { padding: 6px; margin-top: 4px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    textarea { min-height: 80px; width: 100%; resize: vertical; }
    select { max-width: 260px; }
    .contact-row { display: flex; gap: 12px; margin-top: 4px; }
    .contact-row input { flex: 1; }
    .radio-group { display: flex; gap: 16px; margin-top: 6px; }
    .radio-group label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
    .yes { color: green; font-weight: bold; }
    .no { color: red; font-weight: bold; }
    .config-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .config-row input { width: 40%; }
    .config-row select.duration { width: 100px; }
    .config-row select.strategy { width: 140px; }
    .arrow { font-weight: bold; color: #555; margin-left: 5px; margin-right: 5px; }
    .remove-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .remove-btn:hover { background: #e0e0e0; }
    button { margin-top: 12px; padding: 6px 12px; font-size: 13px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #f7f7f7; transition: all 0.2s; display:flex; align-items:center; gap:6px; }
    button:hover { background: #eaeaea; }
    button:disabled { background:#f0f0f0; cursor:not-allowed; }
    .actions { display: flex; gap: 10px; margin-top: 14px; }
    .disabled { background: #f0f0f0; pointer-events: none; }

    /* ---------- Header ---------- */
    .header {
      display: flex;
      justify-content: center;  
      align-items: center;
      gap: 10px;
      font-size: 28px;        
      font-weight: bold;
      margin-bottom: 16px;
    }
    .header span.icon { font-size: 32px; }

    /* Practice Name input style */
    #practiceName {
      width: 100%;
      font-size: 14px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      transition: border 0.2s, box-shadow 0.2s;
      height: 34px; /* same height as other inputs */
      box-sizing: border-box;
    }
    #practiceName:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 6px rgba(74,144,226,0.3) inset;
      outline: none;
    }
  </style>
</head>
<body>

<div class="header">
  <span class="icon">üìù</span> EZ Note Generator
</div>

<label class="section">Practice Name</label>
<input id="practiceName" placeholder="Enter Practice Name (for file name only)">

<label class="section">Integration Type</label>
<select id="integrationType">
  <option value="" selected disabled>Select Integration Type</option>
  <option>Opencare Sync</option>
  <option>NexHealth API</option>
  <option>Sikka API</option>
  <option>Carestack API</option>
  <option>Denticon API</option>
  <option>Opendental API</option>
</select>

<label class="section">Contact Info</label>
<div class="contact-row">
  <input id="contactName" placeholder="Contact Name">
  <input id="phoneNumber" placeholder="Phone Number">
</div>

<label class="section">Integration Status</label>
<select id="integrationStatus">
  <option value="" selected disabled>Select status</option>
  <option>Pending</option>
  <option>Active</option>
  <option>Stalled</option>
</select>

<label class="section">Server Access</label>
<div class="radio-group">
  <label><input type="radio" name="serverAccess" value="Yes"><span class="yes">‚úî</span>Yes</label>
  <label><input type="radio" name="serverAccess" value="No"><span class="no">‚úñ</span>No</label>
</div>

<label class="section">Calendar Sync Configured</label>
<div class="radio-group">
  <label><input type="radio" name="calendarSync" value="Yes"> <span class="yes">‚úî</span>Yes</label>
  <label><input type="radio" name="calendarSync" value="No"> <span class="no">‚úñ</span>No</label>
</div>

<label class="section">Configs / Operatory Setup</label>
<div id="configsContainer"></div>
<button id="addOperatoryBtn" onclick="addConfig()">‚ûï Add Operatory</button>

<label class="section">Blocker</label>
<textarea id="blocker" placeholder="- "></textarea>

<label class="section">Setup Summary</label>
<textarea id="setupSummary" placeholder="- Calendar sync completed"></textarea>

<!-- Buttons -->
<div class="actions">
  <button id="copyBtn" disabled>üìã Copy to Clipboard</button>
  <button id="gptFixBtn">‚úèÔ∏è Fix Grammar</button>
  <button id="saveFileBtn" disabled>üíæ Save to File</button>
</div>
<button style="margin-top: 10px;" onclick="clearAll()">üßπ Clear All</button>

<script>
const BACKEND_URL = "https://notes-backend-yheh.onrender.com";
const configsContainer = document.getElementById("configsContainer");

/* Duration dropdown */
function durationDropdown(){
  let html = `<select class="duration"><option value="">Duration</option>`;
  for(let i=5;i<=120;i+=5) html += `<option>${i} mins</option>`;
  return html + `</select>`;
}

/* Strategy dropdown */
function strategyDropdown(){
  return `<select class="strategy">
    <option value="Any Room">Any Room</option>
    <option value="All Rooms">All Rooms</option>
    <option value="Sequential">Sequential</option>
  </select>`;
}

/* Add config row */
function addConfig(isSequentialSecond=false){
  const row = document.createElement("div");
  row.className = "config-row";

  const strategyHtml = isSequentialSecond ? "" : strategyDropdown();
  const arrowHtml = isSequentialSecond ? '<span class="arrow">‚Üí</span>' : '<span class="arrow" style="display:none;">‚Üí</span>';

  row.innerHTML = `
    <input placeholder="Column / Operatory">
    ${durationDropdown()}
    ${strategyHtml}
    ${arrowHtml}
    <button class="remove-btn">‚úï</button>
  `;

  const strategySelect = row.querySelector(".strategy");
  const arrowSpan = row.querySelector(".arrow");

  row.querySelector(".remove-btn").onclick = () => {
    const rows = [...document.querySelectorAll(".config-row")];
    const index = rows.indexOf(row);
    if(strategySelect && strategySelect.value==="Sequential" && rows[index+1]) rows[index+1].remove();
    row.remove();
    validateFields();
  };

  if(strategySelect){
    strategySelect.addEventListener("change",()=>{
      const rows=[...document.querySelectorAll(".config-row")];
      const index=rows.indexOf(row);
      if(strategySelect.value==="Sequential"){
        arrowSpan.style.display="inline";
        if(!rows[index+1]) addConfig(true);
      } else {
        arrowSpan.style.display="none";
        if(rows[index+1] && !rows[index+1].querySelector(".strategy")) rows[index+1].remove();
      }
      validateFields();
    });
  }

  configsContainer.appendChild(row);
  validateFields();
}

/* Clear all */
function clearAll(){
  document.querySelectorAll("input").forEach(i=>{
    if(i.type==="radio") i.checked=false; else i.value="";
  });
  document.querySelectorAll("textarea").forEach(t=>t.value="");
  document.querySelectorAll("select").forEach(s=>s.selectedIndex=0);
  configsContainer.innerHTML="";
  addConfig();
  enableConfigs(true);
  validateFields();
}

/* Auto bullets for blocker */
blocker.addEventListener("keydown", e=>{
  if(e.key==="Enter"){ e.preventDefault(); blocker.value += "\n- "; }
});
blocker.addEventListener("blur", ()=>{
  blocker.value = blocker.value
    .split("\n").map(l=>l.trim()).filter(Boolean)
    .map(l=>l.startsWith("-")?l:`- ${l}`).join("\n");
});

/* Setup Summary - flexible new lines with auto-bullets on blur */
setupSummary.addEventListener("blur", ()=>{
  setupSummary.value = setupSummary.value
    .split("\n")
    .map(l=>l.trim())
    .filter(Boolean)
    .map(l=>l.startsWith("-")?l:`- ${l}`)
    .join("\n");
});

/* Enable/Disable configs */
function enableConfigs(enable){
  document.querySelectorAll(".config-row input, .config-row select").forEach(el=>{
    el.disabled = !enable;
    if(!enable) el.classList.add("disabled"); else el.classList.remove("disabled");
  });
}

/* Calendar sync behavior */
document.querySelectorAll('input[name="calendarSync"]').forEach(r=>{
  r.addEventListener("change", ()=>{
    if(r.value==="No"){
      configsContainer.innerHTML = '<div>- N/A</div>';
      enableConfigs(false);
    } else {
      configsContainer.innerHTML="";
      addConfig();
      enableConfigs(true);
    }
    validateFields();
  });
});

// GPT Fix
gptFixBtn.onclick=async()=>{
  if(!setupSummary.value) return;
  const res=await fetch(`${BACKEND_URL}/summary`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text:setupSummary.value})
  });
  const data=await res.json();
  setupSummary.value=data.cleaned;
};

// Copy note
copyBtn.onclick = async () => {
  const noteText = generateCurrentNote();
  await navigator.clipboard.writeText(noteText);
  alert("Copied to clipboard");
};

// Save to File
saveFileBtn.onclick = () => {
  const noteText = generateCurrentNote();
  const practiceName = document.getElementById("practiceName").value || "EZ_Note";
  const blob = new Blob([noteText], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = practiceName.replace(/[^a-z0-9]/gi, "_") + ".txt";
  a.click();
  URL.revokeObjectURL(url);
};

/* Generate note content */
function generateCurrentNote(){
  const integrationTypeVal = integrationType.value || "Not selected";
  const integrationStatusVal = integrationStatus.value || "Not set";
  const serverAccessVal = document.querySelector('input[name="serverAccess"]:checked')?.value || "Not set";
  const calendarSyncVal = document.querySelector('input[name="calendarSync"]:checked')?.value || "Not set";

  let configs = "";
  if(calendarSyncVal === "No"){
    configs = "- N/A";
  } else {
    const rows = [...document.querySelectorAll(".config-row")];
    configs = rows.map((r, i) => {
      const op = r.querySelector("input")?.value || "";
      const dur = r.querySelector(".duration")?.value || "";
      const strat = r.querySelector(".strategy");
      const isSequentialSecond = !strat;

      if(isSequentialSecond){
        const prev = rows[i - 1];
        const prevOp = prev.querySelector("input").value;
        const prevDur = prev.querySelector(".duration").value;
        return `- ${prevOp} | ${prevDur} ‚Üí ${op} | ${dur} Sequential`;
      }

      if(strat && strat.value === "Sequential" && rows[i + 1]) return "";
      return `- ${op} | ${dur} | ${strat ? strat.value : ""}`;
    }).filter(Boolean).join("\n");
  }

  const note = `
Integration Type: ${integrationTypeVal}

Contact Name: ${contactName.value}
Phone Number: ${phoneNumber.value}
Integration Status: ${integrationStatusVal}

Server Access: ${serverAccessVal}
Calendar Sync Configured: ${calendarSyncVal}

Configs / Operatory Setup:
${configs}

Blocker:
${blocker.value}

Setup Summary:
${setupSummary.value}
`.trim();

  return note;
}

/* Validation for required fields */
function validateFields() {
  const integrationTypeVal = integrationType.value;
  const integrationStatusVal = integrationStatus.value;
  const serverAccessVal = document.querySelector('input[name="serverAccess"]:checked')?.value;
  const calendarSyncVal = document.querySelector('input[name="calendarSync"]:checked')?.value;

  let configsFilled = false;
  if(calendarSyncVal === "No"){
    configsFilled = true;
  } else {
    const rows = [...document.querySelectorAll(".config-row")];
    configsFilled = rows.length > 0 && rows.every(r=>{
      const op = r.querySelector("input")?.value;
      const dur = r.querySelector(".duration")?.value;
      const strat = r.querySelector(".strategy");
      return op && dur && (strat || true);
    });
  }

  const allRequiredFilled = integrationTypeVal && integrationStatusVal && serverAccessVal && calendarSyncVal && configsFilled;

  copyBtn.disabled = !allRequiredFilled;
  saveFileBtn.disabled = !allRequiredFilled;
}

integrationType.addEventListener("change", validateFields);
integrationStatus.addEventListener("change", validateFields);
document.querySelectorAll('input[name="serverAccess"]').forEach(r => r.addEventListener("change", validateFields));
document.querySelectorAll('input[name="calendarSync"]').forEach(r => r.addEventListener("change", validateFields));
configsContainer.addEventListener("input", validateFields);
configsContainer.addEventListener("change", validateFields);

addConfig();
validateFields();
</script>
</body>
</html>
